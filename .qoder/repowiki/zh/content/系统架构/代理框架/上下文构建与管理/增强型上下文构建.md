# å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»º

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨æ–‡ä»¶**
- [enhanced_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\enhanced_context_builder.py)
- [smart_context_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\smart_context_utils.py)
- [parent_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\parent_context_builder.py)
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py)
- [knowledge_store.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\knowledge_store.py)
- [agent_io_models.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\agent_io_models.py)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡æ¨¡å¼](#æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡æ¨¡å¼)
3. [å¤šæºä¿¡æ¯èåˆæœºåˆ¶](#å¤šæºä¿¡æ¯èåˆæœºåˆ¶)
4. [ç­–ç•¥ç±»åŠ¨æ€è°ƒç”¨æµç¨‹](#ç­–ç•¥ç±»åŠ¨æ€è°ƒç”¨æµç¨‹)
5. [SmartContextUtilsåä½œå…³ç³»](#smartcontextutilsåä½œå…³ç³»)
6. [é€’å½’å­ä»»åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†](#é€’å½’å­ä»»åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†)
7. [å®é™…æ¡ˆä¾‹åˆ†æ](#å®é™…æ¡ˆä¾‹åˆ†æ)
8. [æ€§èƒ½ç“¶é¢ˆä¸ä¼˜åŒ–æ–¹æ¡ˆ](#æ€§èƒ½ç“¶é¢ˆä¸ä¼˜åŒ–æ–¹æ¡ˆ)
9. [ç»“è®º](#ç»“è®º)

## å¼•è¨€
å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºæ¨¡å—æ˜¯æ™ºèƒ½ç ”ç©¶ä»£ç†ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£åœ¨å¤æ‚ç ”ç©¶ä»»åŠ¡ä¸­æ•´åˆæ¥è‡ªçŸ¥è¯†åº“ã€å®æ—¶å·¥å…·è°ƒç”¨å’Œäººæœºäº¤äº’åé¦ˆï¼ˆHITLï¼‰çš„å¤šæºä¿¡æ¯ã€‚è¯¥æ¨¡å—é€šè¿‡åŠ¨æ€è°ƒç”¨ä¸åŒç­–ç•¥ç±»å®ç°ä¸Šä¸‹æ–‡æ‰©å±•ï¼Œç¡®ä¿ä»£ç†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿè·å–å…¨é¢ä¸”ç›¸å…³çš„èƒŒæ™¯ä¿¡æ¯ã€‚

## æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡æ¨¡å¼
å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¸»è¦ç”±`EnhancedContextBuilder`ã€`SmartContextUtils`å’Œå¤šç§ç­–ç•¥ç±»ç»„æˆã€‚ç³»ç»Ÿé€šè¿‡`KnowledgeStore`ä½œä¸ºä¸­å¤®å­˜å‚¨åº“ï¼Œç»´æŠ¤æ‰€æœ‰ä»»åŠ¡è®°å½•ï¼Œå¹¶åˆ©ç”¨`AgentTaskInput`æ¨¡å‹æä¾›ç»“æ„åŒ–è¾“å…¥ã€‚

```mermaid
classDiagram
class EnhancedContextBuilder {
+resolve_context_for_agent_with_parents()
}
class SmartContextUtils {
+get_smart_child_context()
+get_detailed_summary()
+_intelligent_truncation()
}
class ContextStrategy {
<<interface>>
+get_context()
}
class DependencyContextStrategy {
+get_context()
}
class PrerequisiteSiblingContextStrategy {
+get_context()
}
class AncestorBranchContextStrategy {
+get_context()
}
class GoalReferenceContextStrategy {
+get_context()
}
class ParentContextBuilder {
+build_parent_context()
+_format_context_for_llm()
}
class KnowledgeStore {
+add_or_update_record_from_node()
+get_record()
+get_records_by_status()
}
class AgentTaskInput {
+current_task_id
+current_goal
+current_task_type
+parent_hierarchy_context
+formatted_full_context
}
EnhancedContextBuilder --> SmartContextUtils : "ä½¿ç”¨"
EnhancedContextBuilder --> ContextStrategy : "ç»„åˆ"
EnhancedContextBuilder --> ParentContextBuilder : "é›†æˆ"
EnhancedContextBuilder --> KnowledgeStore : "æŸ¥è¯¢"
EnhancedContextBuilder --> AgentTaskInput : "è¾“å‡º"
ContextStrategy <|-- DependencyContextStrategy
ContextStrategy <|-- PrerequisiteSiblingContextStrategy
ContextStrategy <|-- AncestorBranchContextStrategy
ContextStrategy <|-- GoalReferenceContextStrategy
```

**å›¾ç¤ºæ¥æº**
- [enhanced_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\enhanced_context_builder.py#L1-L62)
- [smart_context_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\smart_context_utils.py#L1-L121)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py#L22-L765)

**ç« èŠ‚æ¥æº**
- [enhanced_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\enhanced_context_builder.py#L1-L62)
- [smart_context_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\smart_context_utils.py#L1-L121)

## å¤šæºä¿¡æ¯èåˆæœºåˆ¶
å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºæ¨¡å—é€šè¿‡å¤šç§ç­–ç•¥å®ç°å¤šæºä¿¡æ¯çš„èåˆï¼š

1. **çŸ¥è¯†åº“å­˜å–**ï¼šä»`KnowledgeStore`ä¸­æ£€ç´¢ç›¸å…³ä»»åŠ¡è®°å½•ï¼ŒåŒ…æ‹¬å·²å®Œæˆçš„ä»»åŠ¡è¾“å‡ºå’Œå†å²æ•°æ®ã€‚
2. **å®æ—¶å·¥å…·è°ƒç”¨ç»“æœ**ï¼šé›†æˆå¤–éƒ¨å·¥å…·ï¼ˆå¦‚ç½‘ç»œæœç´¢ã€åŒºå—é“¾æ•°æ®åˆ†æï¼‰çš„å®æ—¶ç»“æœã€‚
3. **äººæœºäº¤äº’åé¦ˆï¼ˆHITLï¼‰**ï¼šçº³å…¥äººå·¥å®¡æ ¸å’Œåé¦ˆä¿¡æ¯ï¼Œæé«˜å†³ç­–è´¨é‡ã€‚

ç³»ç»Ÿé€šè¿‡`TASK_TYPE_STRATEGY_MAPPING`é…ç½®ä¸åŒä»»åŠ¡ç±»å‹çš„ä¸Šä¸‹æ–‡æ„å»ºç­–ç•¥ï¼Œç¡®ä¿ä¸åŒç±»å‹çš„ä»»åŠ¡èƒ½å¤Ÿè·å–æœ€ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹]) --> CheckTaskType["æ£€æŸ¥ä»»åŠ¡ç±»å‹"]
CheckTaskType --> |WRITE/THINK| ApplyWriteStrategies["åº”ç”¨WRITE/THINKç­–ç•¥"]
CheckTaskType --> |PLAN| ApplyPlanStrategies["åº”ç”¨PLANç­–ç•¥"]
CheckTaskType --> |SEARCH| ApplySearchStrategies["åº”ç”¨SEARCHç­–ç•¥"]
ApplyWriteStrategies --> DependencyContext["ä¾èµ–ä¸Šä¸‹æ–‡ç­–ç•¥"]
ApplyWriteStrategies --> PrerequisiteSibling["å‰ç½®å…„å¼Ÿä¸Šä¸‹æ–‡ç­–ç•¥"]
ApplyWriteStrategies --> AncestorBranch["ç¥–å…ˆåˆ†æ”¯ä¸Šä¸‹æ–‡ç­–ç•¥"]
ApplyWriteStrategies --> GoalReference["ç›®æ ‡å¼•ç”¨ä¸Šä¸‹æ–‡ç­–ç•¥"]
ApplyPlanStrategies --> DependencyContext
ApplyPlanStrategies --> PrerequisiteSibling
ApplyPlanStrategies --> GoalReference
ApplySearchStrategies --> DependencyContext
ApplySearchStrategies --> PrerequisiteSibling
ApplySearchStrategies --> GoalReference
DependencyContext --> CollectData["æ”¶é›†ä¾èµ–æ•°æ®"]
PrerequisiteSibling --> CollectData
AncestorBranch --> CollectData
GoalReference --> CollectData
CollectData --> ProcessData["å¤„ç†æ•°æ®"]
ProcessData --> GenerateContext["ç”Ÿæˆå®Œæ•´ä¸Šä¸‹æ–‡"]
GenerateContext --> End([ç»“æŸ])
```

**å›¾ç¤ºæ¥æº**
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py#L38-L77)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py#L22-L765)

**ç« èŠ‚æ¥æº**
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py#L38-L77)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py#L22-L765)

## ç­–ç•¥ç±»åŠ¨æ€è°ƒç”¨æµç¨‹
ç³»ç»Ÿæ ¹æ®å½“å‰ä»»åŠ¡ç±»å‹åŠ¨æ€é€‰æ‹©å¹¶è°ƒç”¨ç›¸åº”çš„ä¸Šä¸‹æ–‡æ„å»ºç­–ç•¥ã€‚è¿™ä¸€è¿‡ç¨‹é€šè¿‡`TASK_TYPE_STRATEGY_MAPPING`å­—å…¸å®ç°ï¼Œè¯¥å­—å…¸å°†ä»»åŠ¡ç±»å‹æ˜ å°„åˆ°ä¸€ç»„ç­–ç•¥å¯¹è±¡ã€‚

```python
TASK_TYPE_STRATEGY_MAPPING: Dict[str, List[ContextResolutionStrategy]] = {
    "WRITE": [
        DependencyContextStrategy(),
        PrerequisiteSiblingContextStrategy(),
        AncestorBranchContextStrategy(),
        GoalReferenceContextStrategy(),
    ],
    "THINK": [
        DependencyContextStrategy(),
        PrerequisiteSiblingContextStrategy(),
        AncestorBranchContextStrategy(),
        GoalReferenceContextStrategy(),
    ],
    "PLAN": [
        DependencyContextStrategy(),
        PrerequisiteSiblingContextStrategy(),
        GoalReferenceContextStrategy(),
    ],
    "RESEARCH_WEB": [
        DependencyContextStrategy(),
        GoalReferenceContextStrategy(),
    ],
    "SEARCH": [
        DependencyContextStrategy(),
        PrerequisiteSiblingContextStrategy(),
        GoalReferenceContextStrategy(),
    ]
}
```

æ¯ä¸ªç­–ç•¥ç±»éƒ½å®ç°äº†`get_context`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶å½“å‰ä»»åŠ¡è®°å½•ã€çŸ¥è¯†åº“å­˜å‚¨å’Œå…¶ä»–å‚æ•°ï¼Œè¿”å›ä¸€ä¸ª`ContextItem`åˆ—è¡¨ã€‚è¿™äº›ç­–ç•¥æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿æœ€é‡è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯é¦–å…ˆè¢«å¤„ç†ã€‚

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant ContextBuilder as "ä¸Šä¸‹æ–‡æ„å»ºå™¨"
participant Strategy as "ç­–ç•¥ç±»"
participant KnowledgeStore as "çŸ¥è¯†åº“å­˜å‚¨"
Client->>ContextBuilder : è¯·æ±‚ä¸Šä¸‹æ–‡
ContextBuilder->>ContextBuilder : ç¡®å®šä»»åŠ¡ç±»å‹
ContextBuilder->>ContextBuilder : è·å–ç­–ç•¥åˆ—è¡¨
loop æ¯ä¸ªç­–ç•¥
ContextBuilder->>Strategy : è°ƒç”¨get_context()
Strategy->>KnowledgeStore : æŸ¥è¯¢ç›¸å…³ä¿¡æ¯
KnowledgeStore-->>Strategy : è¿”å›æ•°æ®
Strategy->>ContextBuilder : è¿”å›ä¸Šä¸‹æ–‡é¡¹
end
ContextBuilder->>ContextBuilder : åˆå¹¶æ‰€æœ‰ä¸Šä¸‹æ–‡é¡¹
ContextBuilder->>Client : è¿”å›å®Œæ•´ä¸Šä¸‹æ–‡
```

**å›¾ç¤ºæ¥æº**
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py#L180-L292)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py#L22-L765)

**ç« èŠ‚æ¥æº**
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py#L180-L292)
- [strategies.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\strategies.py#L22-L765)

## SmartContextUtilsåä½œå…³ç³»
`SmartContextUtils`æ¨¡å—ä¸å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºå™¨ç´§å¯†åä½œï¼Œæä¾›æ™ºèƒ½åŒ–çš„ä¸Šä¸‹æ–‡å¤„ç†åŠŸèƒ½ã€‚å…¶ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š

1. **æ™ºèƒ½ä¸Šä¸‹æ–‡è£å‰ª**ï¼šæ ¹æ®å†…å®¹é•¿åº¦å†³å®šæ˜¯å¦åŒ…å«å…¨æ–‡æˆ–åˆ›å»ºè¯¦ç»†æ‘˜è¦ã€‚
2. **è¯¦ç»†æ‘˜è¦ç”Ÿæˆ**ï¼šä½¿ç”¨ä¸“é—¨çš„æ‘˜è¦ä»£ç†ç”Ÿæˆé«˜è´¨é‡çš„æ‘˜è¦ã€‚
3. **æ™ºèƒ½æˆªæ–­**ï¼šå½“æ‘˜è¦ç”Ÿæˆå¤±è´¥æ—¶ï¼Œæä¾›æ™ºèƒ½æˆªæ–­ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆã€‚

```python
def get_smart_child_context(
    content: Any, 
    child_task_goal: str,
    child_task_type: str,
    force_detailed_summary: bool = False
) -> tuple[str, str]:
    """
    ç”¨äºå­èŠ‚ç‚¹åˆ°çˆ¶èŠ‚ç‚¹æµçš„æ™ºèƒ½ä¸Šä¸‹æ–‡å¤§å°æ§åˆ¶ã€‚
    
    è¿”å›:
        tuple[content_text, processing_method]
        - content_text: è¦å‘ä¸Šä¼ é€’çš„å®é™…å†…å®¹
        - processing_method: å¤„ç†æ–¹å¼æè¿° ("full", "detailed_summary")
    """
    if not content:
        return "", "empty"
    
    # è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    content_str = ""
    if isinstance(content, str):
        content_str = content
    elif hasattr(content, 'model_dump_json'):
        content_str = content.model_dump_json(indent=2)
    else:
        content_str = str(content)
    
    if not content_str.strip():
        return "", "empty"
    
    # è®¡ç®—å¤§å°æŒ‡æ ‡
    char_count = len(content_str)
    word_count = len(content_str.split())
    
    # å†³ç­–é€»è¾‘ï¼šé™¤éå†…å®¹è¿‡é•¿ï¼Œå¦åˆ™åŒ…å«å…¨æ–‡
    if not force_detailed_summary and word_count <= FULL_CONTENT_WORD_LIMIT and char_count <= FULL_CONTENT_CHAR_LIMIT:
        logger.info(f"åŒ…å«å…¨æ–‡å†…å®¹ ({word_count} è¯, {char_count} å­—ç¬¦)")
        return content_str, "full"
    
    # å†…å®¹è¿‡é•¿ - åˆ›å»ºè¯¦ç»†æ‘˜è¦
    logger.info(f"ä¸ºé•¿å†…å®¹åˆ›å»ºè¯¦ç»†æ‘˜è¦ ({word_count} è¯, {char_count} å­—ç¬¦)")
    return get_detailed_summary(content_str, child_task_goal, child_task_type), "detailed_summary"
```

è¿™ç§åä½œå…³ç³»ç¡®ä¿äº†ç³»ç»Ÿèƒ½å¤Ÿåœ¨ä¿æŒä¸Šä¸‹æ–‡å®Œæ•´æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆç®¡ç†ä¸Šä¸‹æ–‡å¤§å°ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ã€‚

**ç« èŠ‚æ¥æº**
- [smart_context_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\smart_context_utils.py#L1-L121)

## é€’å½’å­ä»»åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†
åœ¨å¤„ç†é€’å½’å­ä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿé‡‡ç”¨ç»§æ‰¿ä¸éš”ç¦»ç›¸ç»“åˆçš„æœºåˆ¶æ¥ç®¡ç†ä¸Šä¸‹æ–‡ã€‚`ParentContextBuilder`è´Ÿè´£æ„å»ºçˆ¶å±‚çº§ä¸Šä¸‹æ–‡ï¼Œè€Œ`KnowledgeStore`ç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ç©ºé—´ã€‚

### ä¸Šä¸‹æ–‡ç»§æ‰¿æœºåˆ¶
```python
def build_parent_context(self, current_task_id: str, overall_project_goal: str) -> Optional[ParentHierarchyContext]:
    """
    ä¸ºä»»åŠ¡æ„å»ºç»“æ„åŒ–çš„çˆ¶ä¸Šä¸‹æ–‡ã€‚
    
    å‚æ•°:
        current_task_id: è¯·æ±‚ä¸Šä¸‹æ–‡çš„ä»»åŠ¡ID
        overall_project_goal: é¡¹ç›®çš„æ€»ä½“ç›®æ ‡
    
    è¿”å›:
        åŒ…å«æ ¼å¼åŒ–çˆ¶ä¿¡æ¯çš„ParentHierarchyContext
    """
    try:
        # è·å–ä»å½“å‰ä»»åŠ¡åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„
        path_to_root = get_task_record_path_to_root(current_task_id, self.knowledge_store)
        
        # ğŸ”¥ FIX: å‡½æ•°è¿”å›æ ¹åˆ°å½“å‰ï¼Œä½†æˆ‘ä»¬éœ€è¦å½“å‰åˆ°æ ¹
        # æ‰€ä»¥éœ€è¦åè½¬ï¼Œç„¶åè·å–çˆ¶èŠ‚ç‚¹
        path_from_current = path_to_root[::-1]  # ç°åœ¨: [å½“å‰, çˆ¶èŠ‚ç‚¹, ç¥–å…ˆèŠ‚ç‚¹, ...]
        
        if len(path_from_current) <= 1:  # æ— çˆ¶èŠ‚ç‚¹ï¼ˆæ ¹ä»»åŠ¡ï¼‰
            return None
        
        # å½“å‰ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªï¼Œçˆ¶èŠ‚ç‚¹éšå
        current_task = path_from_current[0]
        parent_records = path_from_current[1:]  # ç›´æ¥çˆ¶èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹
        
        # æ„å»ºå¸¦ä¼˜å…ˆçº§çš„çˆ¶ä¸Šä¸‹æ–‡èŠ‚ç‚¹
        parent_nodes = []
        for i, parent_record in enumerate(parent_records):
            priority = self._determine_priority(i, len(parent_records), parent_record)
            
            parent_node = ParentContextNode(
                task_id=parent_record.task_id,
                goal=parent_record.goal,
                layer=parent_record.layer or 0,
                task_type=parent_record.task_type,
                result_summary=None,
                key_insights=None,
                constraints_identified=None,
                requirements_specified=None,
                planning_reasoning=None,
                coordination_notes=None,
                timestamp_completed=parent_record.timestamp_completed.isoformat() if parent_record.timestamp_completed else None
            )
            parent_nodes.append(parent_node)
        
        # æ ¼å¼åŒ–ä¾›LLMæ¶ˆè´¹
        formatted_context = self._format_context_for_llm(
            current_task=current_task,
            parent_nodes=parent_nodes,
            overall_project_goal=overall_project_goal
        )
        
        # ç¡®å®šæ•´ä½“ä¼˜å…ˆçº§
        overall_priority = self._determine_overall_priority(parent_nodes)
        
        # åˆ›å»ºä½ç½®æè¿°
        position_desc = self._create_position_description(current_task, parent_nodes)
        
        return ParentHierarchyContext(
            current_position=position_desc,
            parent_chain=parent_nodes,
            formatted_context=formatted_context,
            priority_level=overall_priority
        )
        
    except Exception as e:
        logger.error(f"ParentContextBuilder: ä¸º {current_task_id} æ„å»ºä¸Šä¸‹æ–‡æ—¶å‡ºé”™: {e}")
        return None
```

### ä¸Šä¸‹æ–‡éš”ç¦»æœºåˆ¶
æ¯ä¸ªå­ä»»åŠ¡åœ¨æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ç©ºé—´ï¼Œé€šè¿‡`TaskRecord`ä¸­çš„`aux_data`å­—æ®µå­˜å‚¨ç‰¹å®šäºä»»åŠ¡çš„å…ƒæ•°æ®ï¼Œç¡®ä¿ä¸åŒå­ä»»åŠ¡ä¹‹é—´çš„ä¸Šä¸‹æ–‡ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

```mermaid
graph TD
Root((æ ¹ä»»åŠ¡)) --> Layer1A((ç¬¬ä¸€å±‚A))
Root --> Layer1B((ç¬¬ä¸€å±‚B))
Root --> Layer1C((ç¬¬ä¸€å±‚C))
Layer1A --> Layer2A1((ç¬¬äºŒå±‚A1))
Layer1A --> Layer2A2((ç¬¬äºŒå±‚A2))
Layer1B --> Layer2B1((ç¬¬äºŒå±‚B1))
Layer1C --> Layer2C1((ç¬¬äºŒå±‚C1))
Layer1C --> Layer2C2((ç¬¬äºŒå±‚C2))
Layer1C --> Layer2C3((ç¬¬äºŒå±‚C3))
subgraph "ä¸Šä¸‹æ–‡ç»§æ‰¿"
Layer2A1 -.->|ç»§æ‰¿| Layer1A
Layer2A2 -.->|ç»§æ‰¿| Layer1A
Layer2B1 -.->|ç»§æ‰¿| Layer1B
Layer2C1 -.->|ç»§æ‰¿| Layer1C
Layer2C2 -.->|ç»§æ‰¿| Layer1C
Layer2C3 -.->|ç»§æ‰¿| Layer1C
end
subgraph "ä¸Šä¸‹æ–‡éš”ç¦»"
Layer2A1 -.->|ç‹¬ç«‹| ContextA1
Layer2A2 -.->|ç‹¬ç«‹| ContextA2
Layer2B1 -.->|ç‹¬ç«‹| ContextB1
Layer2C1 -.->|ç‹¬ç«‹| ContextC1
Layer2C2 -.->|ç‹¬ç«‹| ContextC2
Layer2C3 -.->|ç‹¬ç«‹| ContextC3
end
```

**å›¾ç¤ºæ¥æº**
- [parent_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\parent_context_builder.py#L6-L264)
- [knowledge_store.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\knowledge_store.py#L12-L46)

**ç« èŠ‚æ¥æº**
- [parent_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\parent_context_builder.py#L6-L264)
- [knowledge_store.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\knowledge_store.py#L12-L46)

## å®é™…æ¡ˆä¾‹åˆ†æ
è€ƒè™‘ä¸€ä¸ªæŠ•èµ„æŠ¥å‘Šæ’°å†™ä»»åŠ¡ï¼Œç³»ç»Ÿéœ€è¦æ•´åˆå¤šä¸ªæ¥æºçš„ä¿¡æ¯æ¥æ”¯æŒä»£ç†å†³ç­–ã€‚

### æ¡ˆä¾‹åœºæ™¯
å‡è®¾ç”¨æˆ·è¯·æ±‚ï¼š"æ’°å†™ä¸€ä»½å…³äº2024å¹´åŠ å¯†è´§å¸å¸‚åœºè¶‹åŠ¿çš„æŠ•èµ„æŠ¥å‘Šï¼Œé‡ç‚¹å…³æ³¨ESGå› ç´ ã€‚"

### ä¸Šä¸‹æ–‡å¢å¼ºå‰åå¯¹æ¯”

#### å¢å¼ºå‰
- **å¯ç”¨ä¿¡æ¯**ï¼šåŸºæœ¬ä»»åŠ¡ç›®æ ‡å’Œçº¦æŸ
- **å†³ç­–è´¨é‡**ï¼šæœ‰é™ï¼Œç¼ºä¹å…·ä½“æ•°æ®æ”¯æŒ
- **è¾“å‡ºç¤ºä¾‹**ï¼š
```json
{
 "parent_goal": "æ’°å†™æŠ•èµ„æŠ¥å‘Š",
 "parent_constraints": ["å…³æ³¨2024å¹´æ•°æ®", "åŒ…å«ESGå› ç´ "],
 "inherited_context": {
   "æ€»ä½“ç›®æ ‡": "å­£åº¦æŠ•èµ„ç»„åˆå›é¡¾",
   "é£æ ¼æŒ‡å—": "æ­£å¼"
 }
}
```

#### å¢å¼ºå
- **å¯ç”¨ä¿¡æ¯**ï¼šæ•´åˆäº†çŸ¥è¯†åº“ä¸­çš„å†å²æ•°æ®ã€å®æ—¶å¸‚åœºæ•°æ®ã€å…ˆå‰ä»»åŠ¡çš„ç»“æœå’Œäººå·¥åé¦ˆ
- **å†³ç­–è´¨é‡**ï¼šæ˜¾è‘—æå‡ï¼ŒåŸºäºå…¨é¢çš„æ•°æ®åˆ†æ
- **è¾“å‡ºç¤ºä¾‹**ï¼š
```json
{
  "dependency_context": {
    "depends_on": ["research_task_1", "research_task_2"],
    "sibling_results": [
      {"task_id": "research_task_1", "output": "å…¬å¸Aåˆ†æ..."},
      {"task_id": "research_task_2", "output": "å…¬å¸Båˆ†æ..."}
    ]
  },
  "parent_hierarchy_context": {
    "current_position": "ç¬¬2å±‚ä»»åŠ¡ï¼Œä½äº'å¸‚åœºåˆ†æ'ä¹‹ä¸‹ï¼ˆæ·±åº¦ï¼š2ï¼‰",
    "parent_chain": [
      {
        "task_id": "plan_1",
        "goal": "åˆ¶å®šç ”ç©¶è®¡åˆ’",
        "layer": 1,
        "task_type": "PLAN",
        "planning_reasoning": "è®¡åˆ’äº†5ä¸ªå­ä»»åŠ¡"
      }
    ],
    "formatted_context": "é¡¹ç›®ç›®æ ‡ï¼šæ’°å†™2024å¹´åŠ å¯†è´§å¸å¸‚åœºè¶‹åŠ¿æŠ¥å‘Š\n\nçˆ¶ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼š\n  ç›´æ¥çˆ¶ä»»åŠ¡ï¼šå¸‚åœºåˆ†æ\n    è§„åˆ’æ–¹æ³•ï¼šè®¡åˆ’äº†5ä¸ªå­ä»»åŠ¡"
  },
  "formatted_full_context": "é¡¹ç›®ç›®æ ‡ï¼šæ’°å†™2024å¹´åŠ å¯†è´§å¸å¸‚åœºè¶‹åŠ¿æŠ¥å‘Š\n\n=== åŒçº§ä¸å†å²ä¸Šä¸‹æ–‡ ===\n\næ¥æºï¼šå¸‚åœºåˆ†æ\nç±»å‹ï¼šç ”ç©¶ç»“æœ\nå†…å®¹ï¼šæ¯”ç‰¹å¸ä»·æ ¼é¢„æµ‹...\n---\n\næ¥æºï¼šç«äº‰å¯¹æ‰‹åˆ†æ\nç±»å‹ï¼šç«äº‰æƒ…æŠ¥\nå†…å®¹ï¼šä»¥å¤ªåŠå¸‚åœºä»½é¢...\n---"
}
```

é€šè¿‡ä¸Šä¸‹æ–‡å¢å¼ºï¼Œä»£ç†èƒ½å¤Ÿç”Ÿæˆæ›´åŠ æ·±å…¥å’Œå‡†ç¡®çš„åˆ†ææŠ¥å‘Šï¼Œæ˜¾è‘—æé«˜äº†å†³ç­–è´¨é‡ã€‚

**ç« èŠ‚æ¥æº**
- [enhanced_context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\enhanced_context_builder.py#L1-L62)
- [context_builder.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\context_builder.py#L180-L292)

## æ€§èƒ½ç“¶é¢ˆä¸ä¼˜åŒ–æ–¹æ¡ˆ
å°½ç®¡å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºæ¨¡å—åŠŸèƒ½å¼ºå¤§ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ä»å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆï¼Œç‰¹åˆ«æ˜¯ä¿¡æ¯å†—ä½™ç´¯ç§¯é—®é¢˜ã€‚

### æ½œåœ¨ç“¶é¢ˆ
1. **ä¿¡æ¯å†—ä½™ç´¯ç§¯**ï¼šéšç€ä»»åŠ¡å±‚çº§åŠ æ·±ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯å¯èƒ½é‡å¤ç´¯ç§¯ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡è¿‡å¤§ã€‚
2. **è®¡ç®—å¼€é”€**ï¼šå¤šä¸ªç­–ç•¥ç±»çš„è¿ç»­æ‰§è¡Œå¢åŠ äº†è®¡ç®—è´Ÿæ‹…ã€‚
3. **å†…å­˜å ç”¨**ï¼šå¤§é‡ä¸Šä¸‹æ–‡æ•°æ®çš„å­˜å‚¨å’Œä¼ è¾“æ¶ˆè€—è¾ƒå¤šå†…å­˜èµ„æºã€‚

### åŸºäºæ³¨æ„åŠ›æƒé‡çš„ç­›é€‰ä¼˜åŒ–æ–¹æ¡ˆ
ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæå‡ºåŸºäºæ³¨æ„åŠ›æƒé‡çš„ä¸Šä¸‹æ–‡ç­›é€‰ä¼˜åŒ–æ–¹æ¡ˆï¼š

```python
class AttentionBasedContextFilter:
    """åŸºäºæ³¨æ„åŠ›æƒé‡çš„ä¸Šä¸‹æ–‡ç­›é€‰å™¨"""
    
    def __init__(self, attention_model: AgnoAgent):
        self.attention_model = attention_model
    
    def calculate_attention_weights(self, context_items: List[ContextItem], 
                                  current_task_goal: str) -> Dict[str, float]:
        """
        è®¡ç®—æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹çš„æ³¨æ„åŠ›æƒé‡ã€‚
        
        å‚æ•°:
            context_items: ä¸Šä¸‹æ–‡é¡¹åˆ—è¡¨
            current_task_goal: å½“å‰ä»»åŠ¡ç›®æ ‡
            
        è¿”å›:
            ä»»åŠ¡IDåˆ°æ³¨æ„åŠ›æƒé‡çš„æ˜ å°„
        """
        weights = {}
        for item in context_items:
            prompt = f"""
            ä»»åŠ¡ç›®æ ‡: {current_task_goal}
            ä¸Šä¸‹æ–‡é¡¹ç›®æ ‡: {item.source_task_goal}
            å†…å®¹ç±»å‹: {item.content_type_description}
            å†…å®¹æ‘˜è¦: {str(item.content)[:500]}...
            
            è¯·è¯„ä¼°æ­¤ä¸Šä¸‹æ–‡é¡¹å¯¹å®Œæˆä¸Šè¿°ä»»åŠ¡ç›®æ ‡çš„é‡è¦æ€§ï¼Œ
            ç”¨0-1ä¹‹é—´çš„æ•°å€¼è¡¨ç¤ºé‡è¦æ€§ç¨‹åº¦ã€‚
            åªè¿”å›æ•°å­—ï¼Œä¸è¦è§£é‡Šã€‚
            """
            try:
                response = self.attention_model.run(prompt)
                weight = float(response.content.strip())
                weights[item.source_task_id] = max(0, min(1, weight))  # ç¡®ä¿åœ¨0-1èŒƒå›´å†…
            except:
                weights[item.source_task_id] = 0.5  # é»˜è®¤æƒé‡
                
        return weights
    
    def filter_context_by_attention(self, context_items: List[ContextItem],
                                  current_task_goal: str,
                                  top_k: int = 10) -> List[ContextItem]:
        """
        æ ¹æ®æ³¨æ„åŠ›æƒé‡ç­›é€‰ä¸Šä¸‹æ–‡é¡¹ã€‚
        
        å‚æ•°:
            context_items: åŸå§‹ä¸Šä¸‹æ–‡é¡¹åˆ—è¡¨
            current_task_goal: å½“å‰ä»»åŠ¡ç›®æ ‡
            top_k: ä¿ç•™çš„æœ€é«˜æƒé‡é¡¹æ•°é‡
            
        è¿”å›:
            ç­›é€‰åçš„ä¸Šä¸‹æ–‡é¡¹åˆ—è¡¨
        """
        if not context_items:
            return []
            
        # è®¡ç®—æ³¨æ„åŠ›æƒé‡
        weights = self.calculate_attention_weights(context_items, current_task_goal)
        
        # æŒ‰æƒé‡æ’åºå¹¶é€‰æ‹©top-k
        sorted_items = sorted(context_items, 
                            key=lambda x: weights.get(x.source_task_id, 0), 
                            reverse=True)
        
        return sorted_items[:top_k]
```

è¯¥ä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š
1. ä½¿ç”¨ä¸“é—¨çš„æ³¨æ„åŠ›æ¨¡å‹è¯„ä¼°æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹ä¸å½“å‰ä»»åŠ¡ç›®æ ‡çš„ç›¸å…³æ€§ã€‚
2. ä¸ºæ¯ä¸ªä¸Šä¸‹æ–‡é¡¹åˆ†é…ä¸€ä¸ª0-1ä¹‹é—´çš„æ³¨æ„åŠ›æƒé‡ã€‚
3. æ ¹æ®æƒé‡å¯¹ä¸Šä¸‹æ–‡é¡¹è¿›è¡Œæ’åºï¼Œå¹¶åªä¿ç•™æœ€é‡è¦çš„top-ké¡¹ã€‚

è¿™ç§æ–¹æ³•å¯ä»¥æœ‰æ•ˆå‡å°‘ä¿¡æ¯å†—ä½™ï¼ŒåŒæ—¶ç¡®ä¿æœ€å…³é”®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¢«ä¿ç•™ï¼Œä»è€Œåœ¨ä¿è¯å†³ç­–è´¨é‡çš„åŒæ—¶ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

**ç« èŠ‚æ¥æº**
- [smart_context_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\smart_context_utils.py#L1-L121)
- [utility_agents.py](file://src\sentientresearchagent\hierarchical_agent_framework\agents\definitions\utility_agents.py#L20-L20)

## ç»“è®º
å¢å¼ºå‹ä¸Šä¸‹æ–‡æ„å»ºæ¨¡å—é€šè¿‡åˆ›æ–°çš„è®¾è®¡æ¶æ„å’Œçµæ´»çš„ç­–ç•¥æœºåˆ¶ï¼ŒæˆåŠŸå®ç°äº†åœ¨å¤æ‚ç ”ç©¶ä»»åŠ¡ä¸­å¯¹å¤šæºä¿¡æ¯çš„æœ‰æ•ˆèåˆã€‚ç³»ç»Ÿä¸ä»…èƒ½å¤Ÿä»çŸ¥è¯†åº“ã€å®æ—¶å·¥å…·è°ƒç”¨å’Œäººæœºäº¤äº’åé¦ˆä¸­æå–å…³é”®ä¿¡æ¯ï¼Œè¿˜èƒ½é€šè¿‡`SmartContextUtils`å®ç°æ™ºèƒ½åŒ–çš„ä¸Šä¸‹æ–‡å¤„ç†ã€‚

åœ¨é€’å½’å­ä»»åŠ¡å¤„ç†æ–¹é¢ï¼Œç³»ç»Ÿé‡‡ç”¨äº†ç»§æ‰¿ä¸éš”ç¦»ç›¸ç»“åˆçš„æœºåˆ¶ï¼Œæ—¢ä¿è¯äº†ä¸Šä¸‹æ–‡çš„è¿è´¯æ€§ï¼Œåˆé¿å…äº†ä¸åŒä»»åŠ¡é—´çš„å¹²æ‰°ã€‚å®é™…æ¡ˆä¾‹è¡¨æ˜ï¼Œç»è¿‡ä¸Šä¸‹æ–‡å¢å¼ºçš„ä»£ç†èƒ½å¤Ÿåšå‡ºæ›´é«˜è´¨é‡çš„å†³ç­–ã€‚

é’ˆå¯¹ä¿¡æ¯å†—ä½™ç´¯ç§¯ç­‰æ½œåœ¨ç“¶é¢ˆï¼Œæå‡ºçš„åŸºäºæ³¨æ„åŠ›æƒé‡çš„ç­›é€‰ä¼˜åŒ–æ–¹æ¡ˆä¸ºç³»ç»Ÿæ€§èƒ½æå‡æä¾›äº†æ–°çš„æ–¹å‘ã€‚æœªæ¥çš„å·¥ä½œå¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢æ›´é«˜æ•ˆçš„æ³¨æ„åŠ›æœºåˆ¶å’Œè‡ªé€‚åº”çš„ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥ï¼Œä»¥åº”å¯¹æ—¥ç›Šå¤æ‚çš„ä»»åŠ¡éœ€æ±‚ã€‚