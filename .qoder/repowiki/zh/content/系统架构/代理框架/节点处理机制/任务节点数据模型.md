# ä»»åŠ¡èŠ‚ç‚¹æ•°æ®æ¨¡å‹

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py)
- [types.py](file://src\sentientresearchagent\hierarchical_agent_framework\types.py)
- [dependency_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\dependency_utils.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ ¸å¿ƒå­—æ®µå®šä¹‰](#æ ¸å¿ƒå­—æ®µå®šä¹‰)
3. [çŠ¶æ€æœºä¸çŠ¶æ€è¿ç§»](#çŠ¶æ€æœºä¸çŠ¶æ€è¿ç§»)
4. [å±‚çº§ç»“æ„ä¸å­å›¾å…³è”](#å±‚çº§ç»“æ„ä¸å­å›¾å…³è”)
5. [èŠ‚ç‚¹åˆå§‹åŒ–ä¸åºåˆ—åŒ–](#èŠ‚ç‚¹åˆå§‹åŒ–ä¸åºåˆ—åŒ–)
6. [çŠ¶æ€è½¬æ¢æœºåˆ¶](#çŠ¶æ€è½¬æ¢æœºåˆ¶)
7. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

## ç®€ä»‹
`TaskNode` æ˜¯æœ¬ç³»ç»Ÿä¸­ä»»åŠ¡æ‰§è¡Œå›¾çš„åŸºæœ¬å•å…ƒï¼Œä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œæˆ–å¯è§„åˆ’çš„ä»»åŠ¡èŠ‚ç‚¹ã€‚è¯¥ç±»åœ¨ `task_node.py` ä¸­å®ç°ï¼ŒåŸºäº Pydantic æ¨¡å‹æ„å»ºï¼Œæ”¯æŒçº¿ç¨‹å®‰å…¨çš„çŠ¶æ€æ›´æ–°ã€çµæ´»çš„çŠ¶æ€è¿ç§»ä»¥åŠä¸°å¯Œçš„å…ƒæ•°æ®è¿½è¸ªã€‚å®ƒä¸ä»…æ‰¿è½½ä»»åŠ¡ç›®æ ‡å’Œç±»å‹ä¿¡æ¯ï¼Œè¿˜ç®¡ç†å¤æ‚çš„çˆ¶å­å…³ç³»ã€ç»“æœå­˜å‚¨å’Œé‡è§„åˆ’é€»è¾‘ã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L1-L50)

## æ ¸å¿ƒå­—æ®µå®šä¹‰
ä»¥ä¸‹æ˜¯ `TaskNode` ç±»çš„å…³é”®å­—æ®µåŠå…¶ç”¨é€”è¯´æ˜ï¼š

| å­—æ®µå | ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
|-------|------|--------|------|
| task_id | str | å¦ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ | å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä½¿ç”¨ UUID è‡ªåŠ¨ç”Ÿæˆ |
| goal | str | æ˜¯ | ä»»åŠ¡çš„å…·ä½“ç›®æ ‡æè¿° |
| task_type | TaskType | æ˜¯ | ä»»åŠ¡ç±»åˆ«ï¼šSEARCH/EXECUTE/THINK/CODE_INTERPRET ç­‰ |
| node_type | NodeType | æ˜¯ | èŠ‚ç‚¹å¤„ç†ç±»å‹ï¼šPLANï¼ˆè®¡åˆ’ï¼‰æˆ– EXECUTEï¼ˆæ‰§è¡Œï¼‰ |
| layer | int | å¦ï¼ˆé»˜è®¤ä¸º0ï¼‰ | å±‚çº§æ·±åº¦ï¼Œç”¨äºè¡¨ç¤ºä»»åŠ¡åˆ†è§£çš„å±‚æ¬¡ |
| parent_node_id | str | å¦ | çˆ¶èŠ‚ç‚¹ IDï¼Œç”¨äºæ„å»ºæ ‘çŠ¶ç»“æ„ |
| status | TaskStatus | å¦ï¼ˆé»˜è®¤PENDINGï¼‰ | å½“å‰çŠ¶æ€ï¼šPENDING â†’ READY â†’ RUNNING â†’ DONE/FAILED |
| result | Any | å¦ | å­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œæ”¯æŒä»»æ„ç±»å‹ï¼ˆæ–‡æœ¬ã€æ¨¡å‹ã€å¼•ç”¨ç­‰ï¼‰ |
| output_summary | str | å¦ | ç»“æœæ‘˜è¦ï¼Œä¾¿äºä¸Šä¸‹æ–‡æ„å»º |
| error | str | å¦ | é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸² |
| agent_name | str | å¦ | å¤„ç†è¯¥ä»»åŠ¡çš„ä»£ç†åç§° |
| sub_graph_id | str | å¦ | PLAN ç±»å‹èŠ‚ç‚¹å¯¹åº”çš„å­å›¾ ID |
| planned_sub_task_ids | List[str] | å¦ | è®°å½•å½“å‰ PLAN èŠ‚ç‚¹ç”Ÿæˆçš„æ‰€æœ‰å­ä»»åŠ¡ ID |
| aux_data | Dict[str, Any] | å¦ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰ | è¾…åŠ©æ•°æ®å­—å…¸ï¼Œç”¨äºå­˜å‚¨ replan ä¸Šä¸‹æ–‡ã€ä¾èµ–ç´¢å¼•ç­‰ |

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L30-L60)

## çŠ¶æ€æœºä¸çŠ¶æ€è¿ç§»
`TaskNode` å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æœ‰é™çŠ¶æ€æœºï¼Œå…¶çŠ¶æ€ç”± `TaskStatus` æšä¸¾å®šä¹‰ï¼Œä½äº `types.py` æ–‡ä»¶ä¸­ã€‚

```mermaid
stateDiagram-v2
[*] --> PENDING
PENDING --> READY : åˆå§‹åŒ–å®Œæˆ
PENDING --> RUNNING : ç›´æ¥å¯åŠ¨
PENDING --> FAILED : åˆå§‹åŒ–å¤±è´¥
PENDING --> CANCELLED : è¢«å–æ¶ˆ
READY --> RUNNING : å¼€å§‹æ‰§è¡Œ
READY --> FAILED : æ‰§è¡Œå‰å‡ºé”™
READY --> CANCELLED : è¢«å–æ¶ˆ
RUNNING --> DONE : æˆåŠŸå®Œæˆ
RUNNING --> PLAN_DONE : è®¡åˆ’ç±»ä»»åŠ¡å®Œæˆ
RUNNING --> FAILED : æ‰§è¡Œå¤±è´¥
RUNNING --> NEEDS_REPLAN : éœ€è¦é‡æ–°è§„åˆ’
RUNNING --> CANCELLED : è¢«å–æ¶ˆ
PLAN_DONE --> AGGREGATING : å‡†å¤‡èšåˆå­ä»»åŠ¡
PLAN_DONE --> FAILED : èšåˆå‰å¤±è´¥
PLAN_DONE --> NEEDS_REPLAN : éœ€è¦é‡æ–°è§„åˆ’
AGGREGATING --> DONE : èšåˆæˆåŠŸ
AGGREGATING --> FAILED : èšåˆå¤±è´¥
AGGREGATING --> NEEDS_REPLAN : èšåˆè¿‡ç¨‹ä¸­éœ€é‡è§„åˆ’
DONE --> NEEDS_REPLAN : å…è®¸é‡è¯•
FAILED --> READY : å¯æ¢å¤é‡è¯•
FAILED --> NEEDS_REPLAN : æ˜ç¡®éœ€è¦é‡è§„åˆ’
CANCELLED --> *
```

**Diagram sources**
- [types.py](file://src\sentientresearchagent\hierarchical_agent_framework\types.py#L12-L25)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L231-L256)

### çŠ¶æ€è¿ç§»æ¡ä»¶ä¸è§¦å‘äº‹ä»¶
- **PENDING â†’ READY**: ä»»åŠ¡å·²åˆ›å»ºå¹¶é…ç½®å®Œæ¯•ï¼Œç­‰å¾…è°ƒåº¦å™¨åˆ†é…èµ„æºã€‚
- **READY â†’ RUNNING**: è°ƒåº¦å™¨é€‰ä¸­è¯¥ä»»åŠ¡å¹¶å¼€å§‹æ‰§è¡Œã€‚
- **RUNNING â†’ PLAN_DONE**: ä»…é€‚ç”¨äº `node_type=PLAN` çš„èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå­ä»»åŠ¡å·²å…¨éƒ¨ç”Ÿæˆä½†å°šæœªèšåˆã€‚
- **PLAN_DONE â†’ AGGREGATING**: æ‰€æœ‰å­ä»»åŠ¡å®Œæˆä¸”çˆ¶èŠ‚ç‚¹å‡†å¤‡æ±‡æ€»ç»“æœã€‚
- **AGGREGATING â†’ DONE**: èšåˆæˆåŠŸï¼Œè¾“å‡ºæœ€ç»ˆç»“æœã€‚
- **ä»»ä½•çŠ¶æ€ â†’ FAILED**: å‘ç”Ÿä¸å¯æ¢å¤é”™è¯¯ï¼Œé€šè¿‡ `fail_with_error()` è§¦å‘ã€‚
- **FAILED â†’ READY / NEEDS_REPLAN**: æ”¯æŒå¤±è´¥åé‡è¯•æˆ–è¯·æ±‚é‡è§„åˆ’ã€‚

ç‰¹åˆ«è¯´æ˜ï¼š**ä¸ºä½• PLAN èŠ‚ç‚¹ä¼šç»å† AGGREGATING é˜¶æ®µï¼Ÿ**  
å› ä¸º PLAN èŠ‚ç‚¹æœ¬èº«ä¸ç›´æ¥äº§ç”Ÿæœ€ç»ˆç­”æ¡ˆï¼Œè€Œæ˜¯è´Ÿè´£å°†å¤æ‚ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ã€‚åªæœ‰å½“æ‰€æœ‰å­ä»»åŠ¡éƒ½å¤„äº `DONE` çŠ¶æ€æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šè¿›å…¥ `AGGREGATING` é˜¶æ®µï¼Œè°ƒç”¨èšåˆé€»è¾‘ï¼ˆå¦‚æ€»ç»“ã€æ•´åˆï¼‰ç”Ÿæˆé«˜å±‚æ¬¡ç»“è®ºã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L231-L256)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L75-L184)

## å±‚çº§ç»“æ„ä¸å­å›¾å…³è”
`TaskNode` æ”¯æŒå¤šå±‚é€’å½’çš„ä»»åŠ¡åˆ†è§£æ¶æ„ï¼Œé€šè¿‡ä»¥ä¸‹å­—æ®µå®ç°ï¼š

- `layer`: è¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ä»»åŠ¡æ ‘ä¸­çš„æ·±åº¦ã€‚æ ¹èŠ‚ç‚¹ä¸º 0 å±‚ï¼Œæ¯å‘ä¸‹åˆ†è§£ä¸€å±‚ï¼Œ`layer` å€¼åŠ  1ã€‚
- `parent_node_id`: æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„ IDï¼Œå½¢æˆçˆ¶å­é“¾è·¯ã€‚
- `planned_sub_task_ids`: PLAN èŠ‚ç‚¹ä½¿ç”¨æ­¤åˆ—è¡¨è®°å½•å…¶ç›´æ¥ç”Ÿæˆçš„æ‰€æœ‰å­ä»»åŠ¡ IDã€‚
- `sub_graph_id`: PLAN èŠ‚ç‚¹ç‰¹æœ‰çš„å­—æ®µï¼ŒæŒ‡å‘å…¶ä¸“å±çš„å­ä»»åŠ¡å›¾ï¼ˆ`TaskGraph`ï¼‰ï¼Œå®ç°é€»è¾‘éš”ç¦»ä¸ç‹¬ç«‹ç®¡ç†ã€‚

> **è®¾è®¡ç”¨é€”**ï¼š`sub_graph_id` çš„å¼•å…¥ä½¿å¾—æ¯ä¸ª PLAN èŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ä»»åŠ¡å­å›¾ï¼Œä¾¿äºæ¨¡å—åŒ–æ‰§è¡Œã€è°ƒè¯•å’Œç¼“å­˜ã€‚ä¾‹å¦‚ï¼Œåœ¨é‡‘èåˆ†æåœºæ™¯ä¸­ï¼Œä¸€ä¸ªé¡¶å±‚â€œæ’°å†™æŠ¥å‘Šâ€ä»»åŠ¡å¯èƒ½åŒ…å«â€œå¸‚åœºè¶‹åŠ¿åˆ†æâ€ã€â€œç«äº‰å¯¹æ‰‹æ¯”è¾ƒâ€ç­‰å¤šä¸ªå­å›¾ï¼Œå„è‡ªç‹¬ç«‹è¿è¡Œäº’ä¸å¹²æ‰°ã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L37-L48)
- [dependency_utils.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\dependency_utils.py#L9-L111)

## èŠ‚ç‚¹åˆå§‹åŒ–ä¸åºåˆ—åŒ–
`TaskNode` åœ¨åˆå§‹åŒ–æ—¶ç¡®ä¿å…³é”®å­—æ®µçš„å¥å£®æ€§ï¼Œå¹¶æ”¯æŒè·¨è¿›ç¨‹åºåˆ—åŒ–ä¼ è¾“ã€‚

```python
def __init__(self, **data):
    # ç¡®ä¿ aux_data æ°¸è¿œä¸ä¼šä¸º None
    if 'aux_data' not in data or data['aux_data'] is None:
        data['aux_data'] = {}
    
    super().__init__(**data)
    # åˆå§‹åŒ–çº¿ç¨‹é”ä»¥ä¿è¯çŠ¶æ€æ›´æ–°å®‰å…¨
    object.__setattr__(self, '_status_lock', threading.RLock())
```

- **åˆå§‹åŒ–ä¿éšœ**ï¼šå³ä½¿ååºåˆ—åŒ–æ—¶ `aux_data` ç¼ºå¤±æˆ–ä¸ºç©ºï¼Œä¹Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºç©ºå­—å…¸ï¼Œé˜²æ­¢åç»­æ“ä½œæŠ¥é”™ã€‚
- **çº¿ç¨‹å®‰å…¨**ï¼šå†…éƒ¨ä½¿ç”¨ `threading.RLock` å®ç°å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„çŠ¶æ€æ›´æ–°ä¿æŠ¤ã€‚
- **åºåˆ—åŒ–å…¼å®¹**ï¼šç»§æ‰¿è‡ª `BaseModel`ï¼Œå¤©ç„¶æ”¯æŒ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œé€‚ç”¨äºç½‘ç»œä¼ è¾“å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L66-L73)

## çŠ¶æ€è½¬æ¢æœºåˆ¶
çŠ¶æ€è½¬æ¢ä¸»è¦é€šè¿‡ `update_status()` æ–¹æ³•å®Œæˆï¼Œå…·å¤‡é«˜å¯é æ€§ä¸å¯è§‚æµ‹æ€§ã€‚

### ä¸»è¦ç‰¹æ€§ï¼š
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ `_status_lock` ä¿è¯å¹¶å‘ç¯å¢ƒä¸‹çŠ¶æ€ä¸€è‡´æ€§ã€‚
- **æ—¥å¿—è¿½è¸ª**ï¼šæ¯æ¬¡çŠ¶æ€å˜æ›´å‡è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€èŠ‚ç‚¹ IDã€å±‚çº§ã€ç›®æ ‡æ‘˜è¦ç­‰ã€‚
- **å³æ—¶èšåˆè§¦å‘**ï¼šå½“ `DONE` çŠ¶æ€è®¾ç½®æˆåŠŸä¸”å­˜åœ¨çˆ¶èŠ‚ç‚¹æ—¶ï¼Œä¼šåœ¨ `aux_data` ä¸­æ·»åŠ  `trigger_parent_aggregation_check` æ ‡è®°ï¼Œé€šçŸ¥æ‰§è¡Œå¼•æ“ç«‹å³æ£€æŸ¥æ˜¯å¦å¯è§¦å‘çˆ¶èŠ‚ç‚¹èšåˆã€‚
- **å¼‚æ­¥é€šçŸ¥**ï¼šè‹¥æä¾› `update_manager`ï¼Œåˆ™é€šè¿‡ asyncio å¼‚æ­¥å¹¿æ’­çŠ¶æ€å˜åŒ–ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

```python
# ç¤ºä¾‹ï¼šæˆåŠŸå®Œæˆä»»åŠ¡å¹¶è§¦å‘çˆ¶èŠ‚ç‚¹èšåˆæ£€æŸ¥
self.update_status(
    TaskStatus.DONE,
    result=final_result,
    result_summary="Generated comprehensive market analysis report"
)
```

æ­¤å¤–ï¼Œç³»ç»Ÿè¿˜æä¾›äº† `update_status_fast()` å¿«é€Ÿè·¯å¾„æ–¹æ³•ï¼Œä¸“ä¸ºâ€œå»¶è¿Ÿæ›´æ–°â€æ¨¡å¼ä¼˜åŒ–ï¼Œè·³è¿‡éªŒè¯ä¸æ—¥å¿—è®°å½•ï¼Œæå‡æ€§èƒ½ã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L75-L184)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L186-L229)

## å¸¸è§é—®é¢˜æ’æŸ¥
### èŠ‚ç‚¹å¡åœ¨ PENDING çŠ¶æ€å¦‚ä½•æ’æŸ¥ï¼Ÿ
1. **æ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦è¿è¡Œ**ï¼šç¡®è®¤ `execution_orchestrator` æˆ– `task_scheduler` æ­£å¸¸å·¥ä½œã€‚
2. **æŸ¥çœ‹æ—¥å¿—ä¸­çš„ STATE TRANSITION è®°å½•**ï¼šæœç´¢ `"ğŸ”„ STATE TRANSITION"` æ—¥å¿—æ¡ç›®ï¼Œç¡®è®¤æ˜¯å¦æœ‰ä» `PENDING` åˆ° `READY/RUNNING` çš„å°è¯•ã€‚
3. **éªŒè¯ä¾èµ–å…³ç³»**ï¼šæŸäº›èŠ‚ç‚¹å¯èƒ½å›  `aux_data.depends_on_indices` å­˜åœ¨æœªå®Œæˆçš„å‰ç½®ä¾èµ–è€Œæ— æ³•å°±ç»ªã€‚
4. **æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½**ï¼šé«˜è´Ÿè½½å¯èƒ½å¯¼è‡´ä»»åŠ¡æ’é˜Ÿï¼Œé•¿æ—¶é—´åœç•™åœ¨ `PENDING`ã€‚
5. **ç¡®è®¤é…ç½®æ–‡ä»¶**ï¼šæ£€æŸ¥ `sentient.yaml` ä¸­æ˜¯å¦å¯ç”¨äº†ç›¸å…³ agent å’Œ handlerã€‚
6. **å‰ç«¯è°ƒè¯•é¢æ¿**ï¼šä½¿ç”¨ `NodeTracingModal` æŸ¥çœ‹èŠ‚ç‚¹å…¨ç”Ÿå‘½å‘¨æœŸè½¨è¿¹ã€‚

> æç¤ºï¼šå¯é€šè¿‡ `NodeUpdateManager` ç›‘å¬çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œå®æ—¶æ•è·å¼‚å¸¸åœæ»æƒ…å†µã€‚

**Section sources**
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L75-L184)
- [websocketService.ts](file://frontend/src/services/websocketService.ts)
- [NodeTracingModal.tsx](file://frontend/src/components/debug/NodeTracingModal.tsx)