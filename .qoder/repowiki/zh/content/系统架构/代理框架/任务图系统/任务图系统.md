# 任务图系统

<cite>
**本文档引用的文件**
- [task_graph.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\task_graph.py)
- [project_initializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\project_initializer.py)
- [state_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\state_manager.py)
- [execution_engine.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\execution_engine.py)
- [cycle_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\cycle_manager.py)
- [graph_serializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\graph_serializer.py)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py)
- [node_processor.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\node_processor.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [任务图结构](#任务图结构)
4. [项目初始化](#项目初始化)
5. [状态管理](#状态管理)
6. [执行引擎](#执行引擎)
7. [循环管理器](#循环管理器)
8. [序列化与可视化](#序列化与可视化)
9. [性能优化建议](#性能优化建议)
10. [结论](#结论)

## 简介
任务图系统是一个复杂的分层代理框架，用于管理和执行研究任务。该系统通过有向无环图（DAG）来表示任务的分解和依赖关系，确保任务按照正确的顺序执行。本文档详细阐述了系统的各个组成部分及其交互方式。

## 核心组件

任务图系统由多个核心组件构成，包括任务图、项目初始化器、状态管理器、执行引擎、循环管理器、图序列化器、任务节点和节点处理器。这些组件协同工作，以实现高效的任务调度和执行。

**Section sources**
- [task_graph.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\task_graph.py#L12-L137)
- [project_initializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\project_initializer.py#L5-L49)
- [state_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\state_manager.py#L13-L160)
- [execution_engine.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\execution_engine.py#L32-L212)
- [cycle_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\cycle_manager.py#L104-L296)
- [graph_serializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\graph_serializer.py#L9-L175)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L18-L285)
- [node_processor.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\node_processor.py#L68-L254)

## 任务图结构

任务图是整个系统的核心数据结构，它使用有向无环图（DAG）来表示任务之间的依赖关系。每个任务节点都有一个唯一的ID，并且可以包含子任务。任务图支持动态添加和删除节点，以及更新节点的状态。

```mermaid
classDiagram
class TaskGraph {
+Dict[str, nx.DiGraph] graphs
+Dict[str, TaskNode] nodes
+Optional[str] root_graph_id
+Optional[str] overall_project_goal
+threading.RLock _lock
+add_graph(graph_id : str, is_root : bool = False) nx.DiGraph
+get_graph(graph_id : str) Optional[nx.DiGraph]
+add_node_to_graph(graph_id : str, node : TaskNode)
+add_edge(graph_id : str, u_node_id : str, v_node_id : str)
+get_node(node_id : str) Optional[TaskNode]
+get_all_nodes() List[TaskNode]
+get_node_predecessors(graph_id : str, node_id : str) List[TaskNode]
+get_node_successors(graph_id : str, node_id : str) List[TaskNode]
+get_nodes_in_graph(graph_id : str) List[TaskNode]
+to_visualization_dict() Dict[str, Any]
}
class TaskNode {
+str goal
+TaskType task_type
+NodeType node_type
+str task_id
+int layer
+Optional[str] parent_node_id
+Optional[str] overall_objective
+TaskStatus status
+Optional[Any] result
+Optional[str] output_summary
+Optional[str] error
+Optional[str] agent_name
+Optional[str] sub_graph_id
+List[str] planned_sub_task_ids
+Optional[ReplanRequestDetails] replan_details
+Optional[str] replan_reason
+int replan_attempts
+Dict[str, Any] aux_data
+threading.RLock _status_lock
+update_status(new_status : TaskStatus, result : Any = None, error_msg : Optional[str] = None, result_summary : Optional[str] = None, validate_transition : bool = True, update_manager : Any = None)
+update_status_fast(new_status : TaskStatus, update_manager : Any = None)
+_is_valid_transition(from_status : TaskStatus, to_status : TaskStatus) bool
+fail_with_error(error : Exception, context : Optional[Dict[str, Any]] = None)
}
TaskGraph --> TaskNode : "contains"
```

**Diagram sources**
- [task_graph.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\task_graph.py#L12-L137)
- [task_node.py](file://src\sentientresearchagent\hierarchical_agent_framework\node\task_node.py#L18-L285)

## 项目初始化

项目初始化器负责创建项目的初始根任务节点和图。当用户设定目标时，项目初始化器会根据目标生成一个根任务节点，并将其添加到任务图中。这个过程确保了所有后续任务都从一个明确的起点开始。

```mermaid
sequenceDiagram
participant User as "用户"
participant ProjectInitializer as "ProjectInitializer"
participant TaskGraph as "TaskGraph"
User->>ProjectInitializer : initialize_project(root_goal, task_graph, knowledge_store)
ProjectInitializer->>TaskGraph : add_graph("root_graph", is_root=True)
TaskGraph-->>ProjectInitializer : 返回图对象
ProjectInitializer->>TaskGraph : add_node_to_graph("root_graph", root_node)
TaskGraph-->>ProjectInitializer : 成功添加节点
ProjectInitializer-->>User : 返回创建的根节点
```

**Diagram sources**
- [project_initializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\project_initializer.py#L5-L49)
- [task_graph.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\task_graph.py#L12-L137)

## 状态管理

状态管理器负责检查节点是否可以转换状态。它通过一系列条件判断来确定节点是否可以从一种状态转换到另一种状态。例如，一个节点只有在其所有前置任务完成后才能从PENDING状态转换为READY状态。

```mermaid
flowchart TD
Start([开始]) --> CheckParent{"检查父节点状态"}
CheckParent --> |父节点运行中| CheckPredecessors{"检查前置任务"}
CheckParent --> |父节点未运行| ReturnFalse["返回 false"]
CheckPredecessors --> |所有前置任务完成| ReturnTrue["返回 true"]
CheckPredecessors --> |存在未完成前置任务| ReturnFalse
ReturnTrue --> End([结束])
ReturnFalse --> End
```

**Diagram sources**
- [state_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\state_manager.py#L13-L160)

## 执行引擎

执行引擎是驱动任务图遍历和节点执行的主要组件。它维护了一个新的模块化架构，同时保持了与旧API的兼容性。执行引擎通过调用不同的服务和管理器来协调任务的执行流程。

```mermaid
classDiagram
class ExecutionEngine {
+TaskGraph task_graph
+StateManager state_manager
+KnowledgeStore knowledge_store
+NodeProcessor node_processor
+AgentRegistry agent_registry
+SentientConfig config
+Optional[CheckpointManager] checkpoint_manager
+Optional[Any] websocket_handler
+HITLService hitl_service
+AgentSelector agent_selector
+ContextBuilderService context_builder
+StateTransitionManager state_transition_manager
+TaskScheduler task_scheduler
+DeadlockDetector deadlock_detector
+RecoveryManager recovery_manager
+HandlerContext handler_context
+ReadyNodeHandler node_handler
+ExecutionOrchestrator orchestrator
+ProjectInitializer project_initializer
+run_project_flow(root_goal : str, root_task_type : TaskType = TaskType.WRITE, max_steps : int = 250) Dict[str, Any]
+run_execution_cycle(max_steps : int = 250, execution_id : Optional[str] = None) Dict[str, Any]
+get_execution_stats() Dict[str, Any]
+get_hitl_metrics() Dict[str, Any]
}
ExecutionEngine --> HITLService : "使用"
ExecutionEngine --> AgentSelector : "使用"
ExecutionEngine --> ContextBuilderService : "使用"
ExecutionEngine --> StateTransitionManager : "使用"
ExecutionEngine --> TaskScheduler : "使用"
ExecutionEngine --> DeadlockDetector : "使用"
ExecutionEngine --> RecoveryManager : "使用"
ExecutionEngine --> HandlerContext : "使用"
ExecutionEngine --> ReadyNodeHandler : "使用"
ExecutionEngine --> ExecutionOrchestrator : "使用"
ExecutionEngine --> ProjectInitializer : "使用"
```

**Diagram sources**
- [execution_engine.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\execution_engine.py#L32-L212)

## 循环管理器

循环管理器负责在执行周期内处理节点状态转换和调度节点处理。它按顺序执行以下步骤：将PENDING状态的节点转换为READY状态，处理AGGREGATING状态的节点，批量并行处理READY状态的节点，以及处理NEEDS_REPLAN状态的节点。

```mermaid
flowchart TD
Start([开始]) --> UpdatePending{"更新 PENDING -> READY 转换"}
UpdatePending --> ProcessAggregating["处理 AGGREGATING 节点 (串行)"]
ProcessAggregating --> ProcessReady["处理 READY 节点 (并行)"]
ProcessReady --> UpdatePlanDone{"更新 PLAN_DONE -> AGGREGATING / READY 转换"}
UpdatePlanDone --> ProcessReplan["处理 NEEDS_REPLAN 节点 (串行)"]
ProcessReplan --> End([结束])
```

**Diagram sources**
- [cycle_manager.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\cycle_manager.py#L104-L296)

## 序列化与可视化

图序列化器负责将任务图转换为适合前端可视化的字典格式。这使得前端能够显示任务图的当前状态，包括节点、边和各种属性。此外，序列化功能还支持持久化存储和调试。

```mermaid
erDiagram
TASK_GRAPH {
string overall_project_goal PK
string root_graph_id FK
}
GRAPH {
string graph_id PK
string task_graph_overall_project_goal FK
}
NODE {
string task_id PK
string goal
string task_type
string node_type
int layer
string parent_node_id FK
string overall_objective
string status
any result
string output_summary
string error
string agent_name
string sub_graph_id FK
string[] planned_sub_task_ids
string replan_reason
int replan_attempts
any aux_data
}
EDGE {
string source PK
string target PK
string graph_id FK
}
TASK_GRAPH ||--o{ GRAPH : "包含"
GRAPH ||--o{ NODE : "包含"
GRAPH ||--o{ EDGE : "包含"
EDGE }|--|| NODE : "源"
EDGE }|--|| NODE : "目标"
```

**Diagram sources**
- [graph_serializer.py](file://src\sentientresearchagent\hierarchical_agent_framework\graph\graph_serializer.py#L9-L175)

## 性能优化建议

为了提高大规模图的性能，建议采取以下措施：
- **内存管理**：使用`OptimizedKnowledgeStore`类，它提供了读取缓存和写入缓冲区，减少了锁争用。
- **并行执行策略**：利用`TaskScheduler`类中的`get_ready_nodes`方法，批量获取可执行的节点，并使用`asyncio.gather`进行并行处理。
- **循环检测最佳实践**：定期调用`DeadlockDetector`类的`detect_deadlock`方法，及时发现并解决死锁问题。

```mermaid
graph TB
subgraph "性能优化"
A[内存管理]
B[并行执行]
C[循环检测]
end
A --> D[使用 OptimizedKnowledgeStore]
B --> E[批量获取 READY 节点]
C --> F[定期检测死锁]
D --> G[减少锁争用]
E --> H[提高吞吐量]
F --> I[避免无限等待]
```

**Diagram sources**
- [optimized_knowledge_store.py](file://src\sentientresearchagent\hierarchical_agent_framework\context\optimized_knowledge_store.py#L75-L275)
- [task_scheduler.py](file://src\sentientresearchagent\hierarchical_agent_framework\orchestration\task_scheduler.py#L22-L553)
- [deadlock_detector.py](file://src\sentientresearchagent\hierarchical_agent_framework\orchestration\deadlock_detector.py#L10-L100)

## 结论

任务图系统通过精心设计的组件和高效的算法实现了复杂研究任务的自动化执行。通过对任务图的合理建模和状态管理，系统能够有效地处理任务间的依赖关系，并确保任务按正确顺序执行。未来的工作可以进一步优化性能，增加更多的监控和调试工具，以提升系统的可靠性和可用性。